<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DESIGNINK | AI Metadata Workspace</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <aside class="sidebar">
        <div class="brand">DESIGN<span>I</span>NK.</div>
        
        <div class="config-section">
            <label><i class="fa-solid fa-key"></i> GROQ API KEY</label>
            <input type="password" id="apiKey" placeholder="gsk_xxxx...">
            <p class="helper">Stored securely in your browser.</p>
        </div>

        <div class="config-section">
            <label><i class="fa-solid fa-layer-group"></i> ADOBE CATEGORY</label>
            <select id="category">
                <option value="3">Abstract (3)</option>
                <option value="12">Architecture (12)</option>
                <option value="11">Interiors (11)</option>
                <option value="13">Business (13)</option>
                <option value="17">Nature (17)</option>
                <option value="1">Animals (1)</option>
            </select>
        </div>

        <div class="nav-actions">
            <button class="btn-primary" onclick="processBatch()" id="startBtn">
                <i class="fa-solid fa-play"></i> START ANALYSIS
            </button>
            <button id="dlBtn" class="btn-success" onclick="downloadCSV()" style="display:none;">
                <i class="fa-solid fa-file-csv"></i> DOWNLOAD CSV
            </button>
        </div>

        <div class="status-card">
            <div class="stat">Queue: <span id="countFiles">0</span></div>
            <div class="stat">Done: <span id="countDone">0</span></div>
        </div>
    </aside>

    <main class="main-view">
        <header class="top-bar">
            <div class="header-info">
                <h1>Batch Metadata Generator</h1>
                <p>Upload up to 500 images. AI will generate Title & Keywords for Adobe Stock.</p>
            </div>
            <div class="upload-zone">
                <label for="fileInput" class="custom-upload">
                    <i class="fa-solid fa-cloud-arrow-up"></i> SELECT IMAGES
                </label>
                <input type="file" id="fileInput" multiple accept="image/*" onchange="handleFiles()">
            </div>
        </header>

        <div class="progress-container" id="progWrapper" style="display:none;">
            <div class="progress-info">
                <span id="statusLabel">Initializing AI...</span>
                <span id="percentLabel">0%</span>
            </div>
            <div class="progress-track"><div class="progress-fill" id="fill"></div></div>
        </div>

        <div class="image-grid" id="grid">
            <div class="empty-state">
                <i class="fa-solid fa-images"></i>
                <p>Workspace empty. Upload assets to begin.</p>
            </div>
        </div>
    </main>

    <script>
        let batchResults = [];
        let filesQueue = [];

        // Save/Load API Key (Extension Style)
        window.onload = () => {
            const savedKey = localStorage.getItem('di_groq_key');
            if(savedKey) document.getElementById('apiKey').value = savedKey;
        };

        function handleFiles() {
            const grid = document.getElementById('grid');
            filesQueue = Array.from(document.getElementById('fileInput').files);
            grid.innerHTML = '';
            document.getElementById('countFiles').innerText = filesQueue.length;

            filesQueue.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const card = document.createElement('div');
                    card.className = 'img-card';
                    card.innerHTML = `
                        <img src="${e.target.result}">
                        <div class="img-meta">
                            <span class="fname">${file.name}</span>
                            <span class="badge" id="tag-${index}">Pending</span>
                        </div>
                    `;
                    grid.appendChild(card);
                };
                reader.readAsDataURL(file);
            });
        }

        async function processBatch() {
            const key = document.getElementById('apiKey').value;
            if(!key || filesQueue.length === 0) return alert("Please enter API key and select images.");
            localStorage.setItem('di_groq_key', key);
            
            document.getElementById('progWrapper').style.display = 'block';
            document.getElementById('startBtn').disabled = true;
            batchResults = [];
            let done = 0;

            for(let i=0; i<filesQueue.length; i++) {
                const file = filesQueue[i];
                const tag = document.getElementById(`tag-${i}`);
                tag.innerText = "Analyzing...";
                tag.className = "badge active";

                try {
                    const b64 = await toBase64(file);
                    
                    // GROQ API LOGIC (Using Llama-3 Vision Model)
                    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: "llama-3.2-11b-vision-preview",
                            messages: [{
                                role: "user",
                                content: [
                                    { type: "text", text: "Adobe Stock Metadata. Return ONLY in this format: Title: [text] | Keywords: [comma separated words]" },
                                    { type: "image_url", image_url: { url: `data:image/jpeg;base64,${b64}` } }
                                ]
                            }]
                        })
                    });

                    const res = await response.json();
                    if(res.error) throw new Error(res.error.message);

                    const aiText = res.choices[0].message.content;
                    const parts = aiText.split('|');
                    
                    batchResults.push({
                        filename: file.name,
                        title: parts[0].replace(/Title:/i, '').trim(),
                        keywords: parts[1].replace(/Keywords:/i, '').trim()
                    });

                    tag.innerText = "Success";
                    tag.className = "badge success";
                    done++;
                    
                    // Update UI Progress
                    const p = Math.round((done / filesQueue.length) * 100);
                    document.getElementById('fill').style.width = p + "%";
                    document.getElementById('percentLabel').innerText = p + "%";
                    document.getElementById('countDone').innerText = done;

                } catch (err) {
                    tag.innerText = "Error";
                    tag.className = "badge error";
                    console.error(err);
                }
            }
            document.getElementById('dlBtn').style.display = 'block';
            document.getElementById('startBtn').disabled = false;
        }

        const toBase64 = f => new Promise(res => {
            const r = new FileReader(); r.readAsDataURL(f);
            r.onload = () => res(r.result.split(',')[1]);
        });

        function downloadCSV() {
            const cat = document.getElementById('category').value;
            // Headers for Adobe Stock
            let csv = "Filename,Title,Keywords,Category,Releases\n";
            batchResults.forEach(r => {
                csv += `"${r.filename}","${r.title.replace(/"/g,'""')}","${r.keywords.replace(/"/g,'""')}",${cat},""\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `AdobeStock_Batch_${Date.now()}.csv`; a.click();
        }
    </script>
</body>
</html>
