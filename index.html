<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DESIGNINK | AI Metadata Pro</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <aside class="sidebar">
        <div class="logo">DESIGN<span>I</span>NK.</div>
        
        <div class="config-section">
            <label><i class="fa-solid fa-key"></i> GROQ API KEY</label>
            <input type="password" id="apiKey" placeholder="gsk_xxxx...">
            <p class="helper">Saved locally in your browser storage.</p>
        </div>

        <div class="config-section">
            <label><i class="fa-solid fa-list"></i> ADOBE CATEGORY</label>
            <select id="category">
                <option value="3">Abstract (3)</option>
                <option value="12">Architecture (12)</option>
                <option value="11">Interiors (11)</option>
                <option value="17">Nature (17)</option>
                <option value="13">Business (13)</option>
            </select>
        </div>

        <div class="nav-actions">
            <button class="btn-primary" onclick="processBatch()" id="startBtn">
                <i class="fa-solid fa-wand-sparkles"></i> START ANALYSIS
            </button>
            <button id="dlBtn" class="btn-success" onclick="downloadCSV()" style="display:none;">
                <i class="fa-solid fa-file-csv"></i> DOWNLOAD CSV
            </button>
        </div>

        <div class="stats-box">
            <div class="stat">Files: <span id="countFiles">0</span></div>
            <div class="stat">Done: <span id="countDone">0</span></div>
        </div>
    </aside>

    <main class="main-content">
        <header class="header">
            <div class="header-text">
                <h1>Batch Metadata Generator</h1>
                <p>Upload up to 500 images. AI will generate Titles & Keywords for Adobe Stock.</p>
            </div>
            <div class="upload-area">
                <label for="fileInput" class="custom-upload">
                    <i class="fa-solid fa-cloud-arrow-up"></i> SELECT IMAGES
                </label>
                <input type="file" id="fileInput" multiple accept="image/*" onchange="handleFiles()">
            </div>
        </header>

        <div class="progress-container" id="progWrapper" style="display:none;">
            <div class="progress-info">
                <span id="statusLabel">AI is thinking...</span>
                <span id="percentLabel">0%</span>
            </div>
            <div class="progress-track"><div class="progress-fill" id="fill"></div></div>
        </div>

        <div class="image-grid" id="grid">
            <div class="empty-state">
                <i class="fa-solid fa-images"></i>
                <p>No images loaded. Select files to begin your workspace.</p>
            </div>
        </div>
    </main>

    <script>
        let batchData = [];
        let uploadedFiles = [];

        // Load Key from Browser Storage (Like your extension does)
        window.onload = () => {
            const saved = localStorage.getItem('groq_key_designink');
            if(saved) document.getElementById('apiKey').value = saved;
        };

        function handleFiles() {
            const grid = document.getElementById('grid');
            uploadedFiles = Array.from(document.getElementById('fileInput').files);
            grid.innerHTML = '';
            document.getElementById('countFiles').innerText = uploadedFiles.length;

            uploadedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const card = document.createElement('div');
                    card.className = 'img-card';
                    card.innerHTML = `
                        <img src="${e.target.result}">
                        <div class="img-meta">
                            <span class="fname">${file.name}</span>
                            <span class="badge" id="tag-${index}">Pending</span>
                        </div>
                    `;
                    grid.appendChild(card);
                };
                reader.readAsDataURL(file);
            });
        }

        async function processBatch() {
            const key = document.getElementById('apiKey').value;
            if(!key || uploadedFiles.length === 0) return alert("Please enter API key and upload images.");
            localStorage.setItem('groq_key_designink', key);
            
            document.getElementById('progWrapper').style.display = 'block';
            batchData = [];
            let doneCount = 0;

            for(let i=0; i<uploadedFiles.length; i++) {
                const file = uploadedFiles[i];
                const tag = document.getElementById(`tag-${i}`);
                tag.innerText = "Analyzing...";
                tag.className = "badge processing";

                try {
                    const base64 = await toBase64(file);
                    // Using your Groq API logic from background.js/panel.js
                    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: "llama-3.2-11b-vision-preview",
                            messages: [{
                                role: "user",
                                content: [
                                    { type: "text", text: "Adobe Stock Metadata. Return ONLY: Title: [70 chars] | Keywords: [40 words comma separated]" },
                                    { type: "image_url", image_url: { url: `data:image/jpeg;base64,${base64}` } }
                                ]
                            }]
                        })
                    });

                    const res = await response.json();
                    const aiResult = res.choices[0].message.content;
                    const parts = aiResult.split('|');
                    
                    batchData.push({
                        filename: file.name,
                        title: parts[0].replace(/Title:/i, '').trim(),
                        keywords: parts[1].replace(/Keywords:/i, '').trim()
                    });

                    tag.innerText = "Success";
                    tag.className = "badge success";
                    doneCount++;
                    
                    const p = Math.round((doneCount / uploadedFiles.length) * 100);
                    document.getElementById('fill').style.width = p + "%";
                    document.getElementById('percentLabel').innerText = p + "%";
                    document.getElementById('countDone').innerText = doneCount;

                } catch (err) {
                    tag.innerText = "Error";
                    tag.className = "badge error";
                }
            }
            document.getElementById('dlBtn').style.display = 'block';
        }

        const toBase64 = f => new Promise(res => {
            const r = new FileReader(); r.readAsDataURL(f);
            r.onload = () => res(r.result.split(',')[1]);
        });

        function downloadCSV() {
            const cat = document.getElementById('category').value;
            // Exact headers from your sample CSV
            let csv = "Filename,Title,Keywords,Category,Releases\n";
            batchData.forEach(r => {
                csv += `"${r.filename}","${r.title.replace(/"/g,'""')}","${r.keywords.replace(/"/g,'""')}",${cat},""\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `DesignInk_AdobeStock.csv`; a.click();
        }
    </script>
</body>
</html>
