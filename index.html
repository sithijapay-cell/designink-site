<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DESIGNINK | AI Metadata Pro</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <nav>
        <a href="index.html" class="logo">DESIGN<span>I</span>NK.</a>
        <div class="nav-links">
            <a href="#" class="active">BATCH GENERATOR</a>
            <a href="https://console.groq.com/keys" target="_blank">GET GROQ KEY</a>
            <a href="https://stock.adobe.com/contributor" target="_blank">ADOBE PORTAL</a>
        </div>
    </nav>

    <main>
        <div class="app-card">
            <h2 style="margin-top:0">Metadata Generator</h2>
            <p style="color:#888; font-size: 14px;">Upload images and generate Adobe Stock CSVs using Groq Llama-3 Vision.</p>

            <div style="margin-top:25px;">
                <label style="font-size:12px; font-weight:700; color:#aaa;">GROQ API KEY</label>
                <input type="password" id="apiKey" class="input-field" placeholder="gsk_xxxxxxxxxxxx">
                <p style="font-size:10px; color:#555;">Key is saved locally in your browser.</p>
            </div>

            <div style="margin-top:20px;">
                <label style="font-size:12px; font-weight:700; color:#aaa;">UPLOAD ASSETS (MAX 500)</label>
                <input type="file" id="fileInput" class="input-field" multiple accept="image/*">
            </div>

            <button class="btn-primary" onclick="processBatch()">START GENERATING</button>

            <div class="progress-wrapper" id="progWrapper">
                <div class="progress-outer"><div class="progress-inner" id="progFill"></div></div>
                <div class="status-text" id="progStatus">Processing 0 of 0...</div>
            </div>

            <div id="terminal">System: Ready for batch...</div>

            <button id="dlBtn" class="btn-primary" style="background:#28a745; display:none;" onclick="downloadCSV()">DOWNLOAD ADOBE STOCK CSV</button>
        </div>
    </main>

    <script>
        let batchData = [];
        
        // Auto-load Key from Storage
        window.onload = () => {
            const savedKey = localStorage.getItem('groq_key');
            if(savedKey) document.getElementById('apiKey').value = savedKey;
        };

        function writeLog(msg) {
            const t = document.getElementById('terminal');
            t.innerHTML += `<div>> ${msg}</div>`;
            t.scrollTop = t.scrollHeight;
        }

        async function processBatch() {
            const key = document.getElementById('apiKey').value;
            const files = Array.from(document.getElementById('fileInput').files);
            
            if(!key || files.length === 0) return alert("Missing API Key or Files");
            
            // Save key for next time
            localStorage.setItem('groq_key', key);
            
            document.getElementById('progWrapper').style.display = 'block';
            document.getElementById('dlBtn').style.display = 'none';
            batchData = [];

            for(let i=0; i<files.length; i++) {
                const file = files[i];
                writeLog(`Processing ${file.name}...`);
                
                // Update Progress Bar
                const percent = ((i + 1) / files.length) * 100;
                document.getElementById('progFill').style.width = percent + "%";
                document.getElementById('progStatus').innerText = `Completed ${i+1} of ${files.length}`;

                try {
                    const base64 = await toBase64(file);
                    
                    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: "llama-3.2-11b-vision-preview",
                            messages: [{
                                role: "user",
                                content: [
                                    { type: "text", text: "Act as Adobe Stock keyworder. Return ONLY: Title: [70 chars] | Keywords: [40 words comma separated]" },
                                    { type: "image_url", image_url: { url: `data:image/jpeg;base64,${base64}` } }
                                ]
                            }]
                        })
                    });

                    const json = await response.json();
                    const aiText = json.choices[0].message.content;
                    
                    const title = aiText.split('|')[0].replace('Title:', '').trim();
                    const keywords = aiText.split('|')[1].replace('Keywords:', '').trim();

                    batchData.push({ f: file.name, t: title, k: keywords });
                    writeLog(`Success: ${file.name}`);

                } catch (e) {
                    writeLog(`Failed: ${file.name}`);
                    batchData.push({ f: file.name, t: "Error Processing", k: "error" });
                }
            }

            writeLog("BATCH COMPLETE.");
            document.getElementById('dlBtn').style.display = 'block';
        }

        const toBase64 = f => new Promise(res => {
            const r = new FileReader(); r.readAsDataURL(f);
            r.onload = () => res(r.result.split(',')[1]);
        });

        function downloadCSV() {
            let csv = "Filename,Title,Keywords,Category,Releases\n";
            batchData.forEach(r => {
                csv += `"${r.f}","${r.t.replace(/"/g,'""')}","${r.k.replace(/"/g,'""')}",3,""\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `DesignInk_AdobeStock_${Date.now()}.csv`; a.click();
        }
    </script>
</body>
</html>
