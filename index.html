<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DESIGNINK | AI Metadata Workspace</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <aside class="sidebar">
        <div class="brand">DESIGN<span>I</span>NK.</div>
        
        <div class="config-section">
            <label><i class="fa-solid fa-key"></i> GROQ API KEY</label>
            <input type="password" id="apiKey" placeholder="gsk_xxxx...">
            <p class="helper">Saved locally in your browser storage.</p>
        </div>

        <div class="nav-actions">
            <button class="btn-primary" onclick="processBatch()" id="startBtn">
                <i class="fa-solid fa-wand-sparkles"></i> START ANALYSIS
            </button>
            <button id="dlBtn" class="btn-success" onclick="downloadCSV()" style="display:none;">
                <i class="fa-solid fa-file-csv"></i> DOWNLOAD CSV
            </button>
        </div>

        <div class="status-panel">
            <div class="stat-item">Uploaded: <span id="countFiles">0</span></div>
            <div class="stat-item">Processed: <span id="countDone">0</span></div>
        </div>
    </aside>

    <main class="workspace">
        <header class="workspace-header">
            <div class="header-text">
                <h1>AI Batch Workspace</h1>
                <p>Auto-generate 50 keywords, 70-char titles, and Category IDs for Adobe Stock.</p>
            </div>
            <div class="upload-wrapper">
                <label for="fileInput" class="upload-label">
                    <i class="fa-solid fa-plus"></i> SELECT IMAGES
                </label>
                <input type="file" id="fileInput" multiple accept="image/*" onchange="handleFiles()">
            </div>
        </header>

        <div class="progress-bar-container" id="progArea" style="display:none;">
            <div class="progress-labels">
                <span id="progStatus">AI is analyzing assets...</span>
                <span id="progPercent">0%</span>
            </div>
            <div class="progress-track"><div class="progress-fill" id="fill"></div></div>
        </div>

        <div class="image-grid" id="grid">
            <div class="empty-state">
                <i class="fa-solid fa-cloud-arrow-up"></i>
                <p>Workspace empty. Select up to 500 images to begin.</p>
            </div>
        </div>
    </main>

    <script>
        let batchData = [];
        let uploadedFiles = [];

        window.onload = () => {
            const saved = localStorage.getItem('designink_groq_key');
            if(saved) document.getElementById('apiKey').value = saved;
        };

        function handleFiles() {
            const grid = document.getElementById('grid');
            uploadedFiles = Array.from(document.getElementById('fileInput').files);
            grid.innerHTML = '';
            document.getElementById('countFiles').innerText = uploadedFiles.length;

            uploadedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const card = document.createElement('div');
                    card.className = 'image-card';
                    card.innerHTML = `
                        <img src="${e.target.result}">
                        <div class="card-footer">
                            <span class="fname">${file.name}</span>
                            <span class="status-tag" id="tag-${index}">Ready</span>
                        </div>
                    `;
                    grid.appendChild(card);
                };
                reader.readAsDataURL(file);
            });
        }

        async function processBatch() {
            const key = document.getElementById('apiKey').value;
            if(!key || uploadedFiles.length === 0) return alert("Please enter API key and upload images.");
            localStorage.setItem('designink_groq_key', key);
            
            document.getElementById('progArea').style.display = 'block';
            document.getElementById('startBtn').disabled = true;
            batchData = [];
            let doneCount = 0;

            for(let i=0; i<uploadedFiles.length; i++) {
                const file = uploadedFiles[i];
                const tag = document.getElementById(`tag-${i}`);
                tag.innerText = "Processing...";
                tag.style.background = "#f39c12";

                try {
                    const base64 = await toBase64(file);
                    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: "llama-3.2-11b-vision-preview",
                            messages: [{
                                role: "user",
                                content: [
                                    { type: "text", text: "Adobe Stock Metadata Expert. Return ONLY this format: Category: [ID] | Title: [max 70 chars] | Keywords: [50 keywords comma separated]. IDs: 3:Abstract, 12:Architecture, 17:Nature, 11:Interiors, 13:Business, 1:Animals, 18:Lifestyle." },
                                    { type: "image_url", image_url: { url: `data:image/jpeg;base64,${base64}` } }
                                ]
                            }]
                        })
                    });

                    const res = await response.json();
                    const aiContent = res.choices[0].message.content;
                    const parts = aiContent.split('|');
                    
                    batchData.push({
                        filename: file.name,
                        category: parts[0].replace(/Category:/i, '').trim(),
                        title: parts[1].replace(/Title:/i, '').trim(),
                        keywords: parts[2].replace(/Keywords:/i, '').trim()
                    });

                    tag.innerText = "Success";
                    tag.style.background = "#10b981";
                    doneCount++;
                    
                    const p = Math.round((doneCount / uploadedFiles.length) * 100);
                    document.getElementById('fill').style.width = p + "%";
                    document.getElementById('progPercent').innerText = p + "%";
                    document.getElementById('countDone').innerText = doneCount;

                } catch (err) {
                    tag.innerText = "Error";
                    tag.style.background = "#e63946";
                    console.error("Critical Error:", err);
                }
            }
            document.getElementById('dlBtn').style.display = 'block';
            document.getElementById('startBtn').disabled = false;
        }

        const toBase64 = f => new Promise(res => {
            const r = new FileReader(); r.readAsDataURL(f);
            r.onload = () => res(r.result.split(',')[1]);
        });

        function downloadCSV() {
            let csv = "Filename,Title,Keywords,Category,Releases\n";
            batchData.forEach(r => {
                csv += `"${r.filename}","${r.title.replace(/"/g,'""')}","${r.keywords.replace(/"/g,'""')}",${r.category},""\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `DesignInk_Batch_Upload.csv`; a.click();
        }
    </script>
</body>
</html>
