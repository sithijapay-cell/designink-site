<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DESIGNINK | AI Metadata Pro</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <aside class="sidebar">
        <div class="brand">DESIGN<span>I</span>NK.</div>
        
        <div class="config-section">
            <label><i class="fa-solid fa-key"></i> GROQ API KEY</label>
            <input type="password" id="apiKey" placeholder="gsk_xxxx...">
            <p class="helper">Saved locally in your browser storage.</p>
        </div>

        <div class="nav-actions">
            <button class="btn-primary" onclick="startProcess()" id="startBtn">
                <i class="fa-solid fa-wand-sparkles"></i> START ANALYSIS
            </button>
            <button id="dlBtn" class="btn-success" onclick="downloadCSV()" style="display:none;">
                <i class="fa-solid fa-file-csv"></i> DOWNLOAD CSV
            </button>
        </div>

        <div class="status-box">
            <div class="stat">Files: <span id="countFiles">0</span></div>
            <div class="stat">Done: <span id="countDone">0</span></div>
        </div>
    </aside>

    <main class="main-content">
        <header class="header">
            <div class="header-info">
                <h1>Batch Workspace</h1>
                <p>Upload up to 500 images. AI will generate Adobe Stock ready data.</p>
            </div>
            <div class="upload-zone">
                <label for="fileInput" class="custom-upload">
                    <i class="fa-solid fa-plus"></i> SELECT IMAGES
                </label>
                <input type="file" id="fileInput" multiple accept="image/*" onchange="handleFiles()">
            </div>
        </header>

        <div class="progress-bar-container" id="progWrapper" style="display:none;">
            <div class="progress-info">
                <span id="statusLabel">AI Analyzing...</span>
                <span id="percentLabel">0%</span>
            </div>
            <div class="progress-track"><div class="progress-fill" id="fill"></div></div>
        </div>

        <div class="image-grid" id="grid">
            <div class="empty-state">
                <i class="fa-solid fa-images"></i>
                <p>No images loaded. Select files to begin.</p>
            </div>
        </div>
    </main>

    <script>
        let batchResults = [];
        let filesQueue = [];

        window.onload = () => {
            const saved = localStorage.getItem('di_groq_key');
            if(saved) document.getElementById('apiKey').value = saved;
        };

        function handleFiles() {
            const grid = document.getElementById('grid');
            filesQueue = Array.from(document.getElementById('fileInput').files);
            grid.innerHTML = '';
            document.getElementById('countFiles').innerText = filesQueue.length;

            filesQueue.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const card = document.createElement('div');
                    card.className = 'img-card';
                    card.innerHTML = `
                        <img src="${e.target.result}">
                        <div class="img-meta">
                            <span class="fname">${file.name}</span>
                            <span class="badge" id="tag-${index}">Pending</span>
                        </div>
                    `;
                    grid.appendChild(card);
                };
                reader.readAsDataURL(file);
            });
        }

        async function startProcess() {
            const key = document.getElementById('apiKey').value;
            if(!key || filesQueue.length === 0) return alert("Missing Key or Files");
            localStorage.setItem('di_groq_key', key);
            
            document.getElementById('progWrapper').style.display = 'block';
            document.getElementById('startBtn').disabled = true;
            batchResults = [];
            let doneCount = 0;

            for(let i=0; i<filesQueue.length; i++) {
                const file = filesQueue[i];
                const tag = document.getElementById(`tag-${i}`);
                tag.innerText = "Analyzing...";
                tag.className = "badge active";

                try {
                    const base64 = await toBase64(file);
                    
                    // The Fetch Call
                    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST',
                        headers: { 
                            'Authorization': `Bearer ${key}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: "llama-3.2-11b-vision-preview",
                            messages: [{
                                role: "user",
                                content: [
                                    { type: "text", text: "Adobe Stock Metadata. Determine Category ID (1-21), Title (70 chars), and 45 keywords. Return ONLY: Category: [ID] | Title: [text] | Keywords: [text]" },
                                    { type: "image_url", image_url: { url: `data:image/jpeg;base64,${base64}` } }
                                ]
                            }]
                        })
                    });

                    const res = await response.json();
                    if(res.error) throw new Error(res.error.message);

                    const aiText = res.choices[0].message.content;
                    const parts = aiText.split('|');
                    
                    batchResults.push({
                        filename: file.name,
                        category: parts[0].replace(/Category:/i, '').trim(),
                        title: parts[1].replace(/Title:/i, '').trim(),
                        keywords: parts[2].replace(/Keywords:/i, '').trim()
                    });

                    tag.innerText = "Success";
                    tag.className = "badge success";
                    doneCount++;
                    
                    const p = Math.round((doneCount / filesQueue.length) * 100);
                    document.getElementById('fill').style.width = p + "%";
                    document.getElementById('percentLabel').innerText = p + "%";
                    document.getElementById('countDone').innerText = doneCount;

                } catch (err) {
                    tag.innerText = "Error";
                    tag.className = "badge error";
                    console.error(err);
                }
            }
            document.getElementById('dlBtn').style.display = 'block';
            document.getElementById('startBtn').disabled = false;
        }

        const toBase64 = f => new Promise(res => {
            const r = new FileReader(); r.readAsDataURL(f);
            r.onload = () => res(r.result.split(',')[1]);
        });

        function downloadCSV() {
            let csv = "Filename,Title,Keywords,Category,Releases\n";
            batchResults.forEach(r => {
                csv += `"${r.filename}","${r.title.replace(/"/g,'""')}","${r.keywords.replace(/"/g,'""')}",${r.category},""\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `AdobeStock_Batch.csv`; a.click();
        }
    </script>
</body>
</html>
