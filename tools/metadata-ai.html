<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch AI Metadata | DESIGNINK.</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        .tool-box { background: white; padding: 40px; border: 1px solid #ddd; border-radius: 4px; margin-top: 30px; text-align: left; }
        .input-group { margin-bottom: 20px; }
        label { display: block; font-weight: 700; margin-bottom: 8px; font-size: 14px; }
        input[type="text"], input[type="password"], input[type="number"], select { 
            width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
        }
        .progress-container { margin: 20px 0; display: none; }
        .progress-bar { width: 100%; background: #eee; height: 10px; border-radius: 5px; overflow: hidden; }
        .progress-fill { width: 0%; height: 100%; background: var(--accent-red); transition: width 0.3s; }
        .stats { font-size: 14px; margin-top: 10px; font-weight: bold; }
        .log { height: 150px; overflow-y: scroll; background: #222; color: #0f0; padding: 10px; font-family: monospace; font-size: 12px; margin-top: 10px; border-radius: 4px; }
        .btn-green { background: #28a745; color: white; padding: 15px 30px; text-decoration: none; border: none; font-weight: bold; cursor: pointer; width: 100%; }
        .btn-green:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>
    <nav>
        <a href="../index.html" class="logo">DESIGN<span>I</span>NK.</a>
        <div class="menu"><a href="../index.html">Home</a><a href="../gallery/index.html">Gallery</a></div>
    </nav>

    <div class="container" style="max-width: 800px;">
        <h1>Batch AI Metadata Generator</h1>
        <p>Upload up to 500 images. Grok AI will describe them and format an Adobe Stock CSV.</p>

        <div class="tool-box">
            <div class="input-group">
                <label>Grok API Key (xai-...)</label>
                <input type="password" id="apiKey" placeholder="Paste your X.ai key here">
            </div>

            <div class="input-group">
                <label>Default Category (Optional - Adobe uses numbers 1-21)</label>
                <input type="number" id="defaultCategory" value="3" placeholder="e.g. 3 for Abstract">
            </div>

            <div class="input-group">
                <label>Select Images (Select up to 500)</label>
                <input type="file" id="fileInput" accept="image/*" multiple>
            </div>

            <button id="startBtn" class="btn-black" onclick="startBatch()">START BATCH PROCESSING</button>

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                <div class="stats" id="statsText">Processing 0 of 0</div>
                <div class="log" id="log">Waiting for start...</div>
            </div>

            <div id="downloadArea" style="display:none; margin-top:20px;">
                <button class="btn-green" onclick="downloadCSV()">DOWNLOAD ADOBE STOCK CSV</button>
            </div>
        </div>
    </div>

    <script>
        let filesToProcess = [];
        let results = [];
        let isProcessing = false;

        function log(msg) {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += `> ${msg}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function startBatch() {
            const apiKey = document.getElementById('apiKey').value;
            const fileInput = document.getElementById('fileInput');
            filesToProcess = Array.from(fileInput.files);

            if (!apiKey) return alert("Please enter your Grok API Key.");
            if (filesToProcess.length === 0) return alert("Please select some images.");
            if (filesToProcess.length > 500) return alert("Please limit to 500 images at a time.");

            // UI Setup
            document.getElementById('startBtn').disabled = true;
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('downloadArea').style.display = 'none';
            results = [];
            
            log(`Starting batch for ${filesToProcess.length} images...`);

            for (let i = 0; i < filesToProcess.length; i++) {
                const file = filesToProcess[i];
                updateProgress(i + 1, filesToProcess.length);
                log(`Processing: ${file.name}`);
                
                try {
                    const metadata = await processWithGrok(file, apiKey);
                    results.push({
                        filename: file.name,
                        title: metadata.title,
                        keywords: metadata.keywords,
                        category: document.getElementById('defaultCategory').value || "",
                        releases: ""
                    });
                    log(`Success: ${file.name}`);
                } catch (err) {
                    log(`Error on ${file.name}: ${err.message}`);
                    // Push empty data so CSV remains aligned
                    results.push({ filename: file.name, title: "Error", keywords: "", category: "", releases: "" });
                }
            }

            log("Batch Complete!");
            document.getElementById('downloadArea').style.display = 'block';
            document.getElementById('startBtn').disabled = false;
        }

        function updateProgress(current, total) {
            const percent = (current / total) * 100;
            document.getElementById('progressFill').style.width = percent + "%";
            document.getElementById('statsText').innerText = `Processing ${current} of ${total}`;
        }

        async function processWithGrok(file, key) {
            // Helper to convert file to base64
            const base64 = await new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(file);
            });

            const response = await fetch('https://api.x.ai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${key}`
                },
                body: JSON.stringify({
                    model: "grok-vision-beta",
                    messages: [
                        {
                            role: "user",
                            content: [
                                { type: "text", text: "Provide a short title (max 70 chars) and 30 comma-separated keywords for this image for Adobe Stock. Format: Title: [title] Keywords: [kw1, kw2...]" },
                                { type: "image_url", image_url: { url: `data:image/jpeg;base64,${base64}` } }
                            ]
                        }
                    ]
                })
            });

            const data = await response.json();
            const text = data.choices[0].message.content;
            
            // Simple regex to extract Title and Keywords from AI response
            const title = text.match(/Title:\s*(.*?)(?=\s*Keywords:|$)/i)?.[1] || "Untitled Design";
            const keywords = text.match(/Keywords:\s*(.*)/i)?.[1] || "";
            
            return { title: title.trim(), keywords: keywords.trim() };
        }

        function downloadCSV() {
            // Exact Adobe Stock Headers from your sample
            let csvRows = ["Filename,Title,Keywords,Category,Releases"];
            
            results.forEach(res => {
                // Ensure keywords/title are wrapped in quotes to handle commas
                csvRows.push(`"${res.filename}","${res.title.replace(/"/g, '""')}","${res.keywords.replace(/"/g, '""')}","${res.category}","${res.releases}"`);
            });

            const csvString = csvRows.join("\n");
            const blob = new Blob([csvString], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', `designink_adobe_stock_${Date.now()}.csv`);
            a.click();
        }
    </script>
</body>
</html>
