<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch AI Metadata Generator | DESIGNINK.</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        .tool-box { background: white; padding: 40px; border: 1px solid #ddd; text-align: left; margin-top: 20px; }
        label { font-weight: 900; font-size: 12px; text-transform: uppercase; display: block; margin-top: 20px; }
        input { width: 100%; padding: 15px; margin-top: 8px; border: 1px solid #ccc; box-sizing: border-box; }
        .log-screen { background: #000; color: #00ff00; padding: 20px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; margin-top: 25px; border-radius: 4px; }
        #dlBtn { background: #28a745; width: 100%; margin-top: 15px; }
    </style>
</head>
<body>
    <nav>
        <a href="../index.html" class="logo">DESIGN<span>I</span>NK.</a>
        <div class="menu"><a href="../index.html">Home</a><a href="metadata-ai.html">Tool</a></div>
    </nav>

    <div class="container" style="max-width: 800px;">
        <h1 style="font-weight: 900;">AI BATCH PROCESSOR</h1>
        <p>Analyze up to 500 images with Grok AI and export a CSV for Adobe Stock.</p>

        <div class="tool-box">
            <label>X.AI (Grok) API Key</label>
            <input type="password" id="apiKey" placeholder="xai-xxxxxxxxxxxx">
            
            <label>Select Images</label>
            <input type="file" id="fileInput" multiple accept="image/*">
            
            <button class="btn-black" onclick="processBatch()" style="width: 100%; margin-top: 30px;">RUN AI ANALYSIS</button>

            <div id="log" class="log-screen">Ready to process...</div>
            
            <button id="dlBtn" class="btn-black" style="display:none;" onclick="downloadCSV()">DOWNLOAD ADOBE STOCK CSV</button>
        </div>
    </div>

    <script>
        let batchResults = [];

        function writeLog(msg) {
            const l = document.getElementById('log');
            l.innerHTML += `<div>> ${msg}</div>`;
            l.scrollTop = l.scrollHeight;
        }

        async function processBatch() {
            const files = Array.from(document.getElementById('fileInput').files);
            const key = document.getElementById('apiKey').value;

            if(!key) return alert("Please enter your API key.");
            if(files.length === 0) return alert("Please select images.");

            document.getElementById('log').innerHTML = "Initializing Grok Vision API...";
            batchResults = [];

            for(let file of files) {
                writeLog(`Analyzing: ${file.name}`);
                
                try {
                    // Logic for Grok Vision API Call
                    const base64 = await toBase64(file);
                    const response = await fetch('https://api.x.ai/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: "grok-vision-beta",
                            messages: [{ role: "user", content: [
                                { type: "text", text: "Return exactly: Title: [max 70 chars description] Keywords: [50 comma separated keywords]" },
                                { type: "image_url", image_url: { url: `data:image/jpeg;base64,${base64}` } }
                            ]}]
                        })
                    });
                    const data = await response.json();
                    const content = data.choices[0].message.content;
                    
                    const title = content.match(/Title:\s*(.*?)(?=\s*Keywords:|$)/i)?.[1] || "Untitled Asset";
                    const keywords = content.match(/Keywords:\s*(.*)/i)?.[1] || "";

                    batchResults.push({ filename: file.name, title, keywords });
                    writeLog(`Success: ${file.name}`);
                } catch (e) {
                    writeLog(`Error processing ${file.name}`);
                    batchResults.push({ filename: file.name, title: "Manual Review Required", keywords: "" });
                }
            }
            writeLog("BATCH FINISHED.");
            document.getElementById('dlBtn').style.display = 'block';
        }

        const toBase64 = file => new Promise((res) => {
            const r = new FileReader(); r.readAsDataURL(file);
            r.onload = () => res(r.result.split(',')[1]);
        });

        function downloadCSV() {
            let csv = "Filename,Title,Keywords,Category,Releases\n";
            batchResults.forEach(r => {
                csv += `"${r.filename}","${r.title.replace(/"/g,'""')}","${r.keywords.replace(/"/g,'""')}",3,""\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `adobe-upload-${Date.now()}.csv`; a.click();
        }
    </script>
</body>
</html>
